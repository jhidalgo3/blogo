In this post I will show you how to resolve a Linq query from an OData formatted url. As from the <a title="http://wcf.codeplex.com/" href="http://wcf.codeplex.com/" target="_blank">WCF WebHttp</a> release in codeplex, the logic to perform this was moved from the WCF DataServices dlls into a stand alone dll called "Microsoft.QueryComposition". This dll required for this sample can be found in the libs folder of the WCF WebHttp source code. First we are going to take a look at a static function taken from the source code of the UrlQueryComposer from the System.ServiceModel namespace:
<pre style="color:#000000;background:#ffffff;"><span style="color:#800000;font-weight:bold;"> public</span> <span style="color:#800000;font-weight:bold;">virtual</span> IEnumerable ComposeQuery<span style="color:#808030;">(</span>IEnumerable rootedQuery<span style="color:#808030;">,</span> <span style="color:#800000;font-weight:bold;">string</span> url<span style="color:#808030;">)</span> <span style="color:#800080;">{</span> Debug<span style="color:#808030;">.</span>Assert<span style="color:#808030;">(</span>rootedQuery <span style="color:#808030;">!</span><span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">null</span><span style="color:#808030;">,</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">queryableRoot should not be null</span><span style="color:#800000;">"</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Debug<span style="color:#808030;">.</span>Assert<span style="color:#808030;">(</span><span style="color:#808030;">!</span>String<span style="color:#808030;">.</span>IsNullOrEmpty<span style="color:#808030;">(</span>url<span style="color:#808030;">)</span><span style="color:#808030;">,</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">url should not be null or empty</span><span style="color:#800000;">"</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">// cast the queryableRoot to an IQueryable type to further compose the query</span> IQueryable queryable <span style="color:#808030;">=</span> rootedQuery <span style="color:#800000;font-weight:bold;">as</span> IQueryable<span style="color:#800080;">;</span> <span style="color:#800000;font-weight:bold;">if</span> <span style="color:#808030;">(</span>queryable <span style="color:#808030;">=</span><span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">null</span><span style="color:#808030;">)</span> <span style="color:#800080;">{</span> queryable <span style="color:#808030;">=</span> rootedQuery<span style="color:#808030;">.</span>AsQueryable<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800080;">}</span> <span style="color:#800000;font-weight:bold;">if</span> <span style="color:#808030;">(</span>queryable <span style="color:#808030;">!</span><span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">null</span><span style="color:#808030;">)</span> <span style="color:#800080;">{</span> IQueryable finalQueryable <span style="color:#808030;">=</span> QueryTranslator<span style="color:#808030;">.</span>Translate<span style="color:#808030;">(</span>queryable<span style="color:#808030;">,</span> url<span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800000;font-weight:bold;">return</span> finalQueryable<span style="color:#800080;">;</span> <span style="color:#800080;">}</span> <span style="color:#800000;font-weight:bold;">return</span> rootedQuery<span style="color:#800080;">;</span> <span style="color:#800080;">}</span></pre>
So basically, we can pass any IEnumerable, and an OData formatted url, and it will return another IEnumerable that will filter the original one. We can easily use this from any type of project, including a console app. Add a reference to the Microsoft.QueryComposition dll to your project, and then try something like this:
<pre style="color:#000000;background:#ffffff;"> var list <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> List<span style="color:#808030;">&lt;</span>Product<span style="color:#808030;">&gt;</span> <span style="color:#800080;">{</span> <span style="color:#800000;font-weight:bold;">new</span> Product <span style="color:#800080;">{</span> ID <span style="color:#808030;">=</span> <span style="color:#008c00;">1</span><span style="color:#808030;">,</span> Name <span style="color:#808030;">=</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">Tenis Ball</span><span style="color:#800000;">"</span><span style="color:#808030;">,</span> Category <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> Category <span style="color:#800080;">{</span> ID <span style="color:#808030;">=</span> <span style="color:#008c00;">1</span><span style="color:#808030;">,</span> Name <span style="color:#808030;">=</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">Sports</span><span style="color:#800000;">"</span><span style="color:#800080;">}</span> <span style="color:#800080;">}</span><span style="color:#808030;">,</span> <span style="color:#800000;font-weight:bold;">new</span> Product <span style="color:#800080;">{</span> ID <span style="color:#808030;">=</span> <span style="color:#008c00;">2</span><span style="color:#808030;">,</span> Name <span style="color:#808030;">=</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">Electric Guitar</span><span style="color:#800000;">"</span><span style="color:#808030;">,</span> Category <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> Category <span style="color:#800080;">{</span> ID <span style="color:#808030;">=</span> <span style="color:#008c00;">2</span><span style="color:#808030;">,</span> Name <span style="color:#808030;">=</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">Music</span><span style="color:#800000;">"</span><span style="color:#800080;">}</span> <span style="color:#800080;">}</span> <span style="color:#800080;">}</span><span style="color:#800080;">;</span> <span style="color:#696969;">//Filter your IEnumerable using OData syntax. (ie x =&gt; x.ID == 2).</span> var url <span style="color:#808030;">=</span> <span style="color:#800000;">"</span><span style="color:#0000e6;">http://localhost/service/products/?$filter=ID%20eq%202</span><span style="color:#800000;">"</span><span style="color:#800080;">;</span> <span style="color:#800000;font-weight:bold;">foreach</span> <span style="color:#808030;">(</span>var i <span style="color:#800000;font-weight:bold;">in</span> ComposeQuery<span style="color:#808030;">(</span>list<span style="color:#808030;">,</span> url<span style="color:#808030;">)</span><span style="color:#808030;">)</span> <span style="color:#800080;">{</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Name: {0}</span><span style="color:#800000;">"</span><span style="color:#808030;">,</span> <span style="color:#808030;">(</span><span style="color:#808030;">(</span>Product<span style="color:#808030;">)</span>i<span style="color:#808030;">)</span><span style="color:#808030;">.</span>Name<span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800080;">}</span> Console<span style="color:#808030;">.</span>ReadKey<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span></pre>
I think this is very cool, and can be very useful for cases in which you want to allow the user to define a filter of some sort, and you want an easy way to store the filter serialized in some repository. Could be a "save search" feature in a search screen, or a security filter to allow or deny access, etc.