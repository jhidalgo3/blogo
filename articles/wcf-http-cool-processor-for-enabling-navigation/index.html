In my previous post I have explain the request and response processor pipelines. I have also showed how you can manage the serialization of request and responses. In this post I am going to show a totally different use for Processors, navigating resources. Say for instance I want to know in which country a certain contact lives. Ideally, I’d like to be able to do something like this: <a href="http://localhost:5555/Contacts/5/Address/City/State/Country">http://localhost:5555/Contacts/5/Address/City/State/Country</a>. The problem in doing a thing like this in WCF HTTP so far, is that you would have to implement a method with a WebGet attribute, and a UriTemplate similar to this one:
<pre style='color:#000000;background:#ffffff;'><span style='color:#808030;'>[</span>WebGet<span style='color:#808030;'>(</span>UriTemplate<span style='color:#808030;'>=</span><span style='color:#800000;'>"</span><span style='color:#0000e6;'>{id}/Address/City/State/Country</span><span style='color:#800000;'>"</span><span style='color:#808030;'>)</span><span style='color:#808030;'>]</span> <span style='color:#800000;font-weight:bold;'>public</span> Country GetContactsCountry<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>int</span> id<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#696969;'>//code here</span> <span style='color:#800080;'>}</span>
</pre>
So you can see the problem right away, I need to define a method for each and every possible navigation sequence, and that’s not desired at all. But what if we could do something like this:
<pre style='color:#000000;background:#ffffff;'><span style='color:#808030;'>[</span>WebGet<span style='color:#808030;'>(</span>UriTemplate<span style='color:#808030;'>=</span><span style='color:#800000;'>"</span><span style='color:#0000e6;'>{id}/*</span><span style='color:#800000;'>"</span><span style='color:#808030;'>)</span><span style='color:#808030;'>]</span> <span style='color:#800000;font-weight:bold;'>public</span> Contact GetContactsNavigation<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>int</span> id<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>repository<span style='color:#808030;'>.</span>Get<span style='color:#808030;'>(</span>id<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span>
</pre>
Then we could try to come up with a mechanism to evaluate the rest of the Uri and navigate through the properties of the resource accordingly.
<h1>Cheating death…</h1>
The first big problem we are going to encounter is the fact that media type processors are expecting a value of the type defined in the Operation, so in our example they are expecting a “Contact” instance. Let’s see a bit of code from the XmlProcessor shipped with WCF HTTP:
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>override</span> <span style='color:#800000;font-weight:bold;'>void</span> WriteToStream<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span> instance<span style='color:#808030;'>,</span> System<span style='color:#808030;'>.</span>IO<span style='color:#808030;'>.</span>Stream stream<span style='color:#808030;'>,</span> HttpRequestMessage request<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#696969;'>//IQueryable support</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>usesQueryComposition<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#696969;'>//wrap it in a list</span> instance <span style='color:#808030;'>=</span> Activator<span style='color:#808030;'>.</span>CreateInstance<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>queryCompositionType<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> var serializer <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span> DataContractSerializer<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>queryCompositionType<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> serializer<span style='color:#808030;'>.</span>WriteObject<span style='color:#808030;'>(</span>stream<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span> var serializer <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span> XmlSerializer<span style='color:#808030;'>(</span>Parameter<span style='color:#808030;'>.</span>ParameterType<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> serializer<span style='color:#808030;'>.</span>Serialize<span style='color:#808030;'>(</span>stream<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span>
</pre>
So when it’s not using query composition (our case) it’s using the Parameter.ParameterType (typeof(Contact) in our example). But if we navigate away from the contact instance, we’ll need a different type in the XmlSerializer. So just because the XmlProcessor is so simple, we could easily tweak the code a little bit to use “instance.GetType()” instead (and we can rename it to CustomXmlProcessor):
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>class</span> CustomXmlProcessor <span style='color:#808030;'>:</span> MediaTypeProcessor <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>private</span> <span style='color:#800000;font-weight:bold;'>bool</span> usesQueryComposition<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>private</span> Type queryCompositionType<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>public</span> XmlProcessor<span style='color:#808030;'>(</span>HttpOperationDescription operation<span style='color:#808030;'>,</span> MediaTypeProcessorMode mode<span style='color:#808030;'>)</span> <span style='color:#808030;'>:</span> <span style='color:#800000;font-weight:bold;'>base</span><span style='color:#808030;'>(</span>operation<span style='color:#808030;'>,</span> mode<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> var returnType <span style='color:#808030;'>=</span> operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#800080;'>;</span> <span style='color:#696969;'>//IQueryable support</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>operation<span style='color:#808030;'>.</span>Behaviors<span style='color:#808030;'>.</span>Contains<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span>QueryCompositionAttribute<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> usesQueryComposition <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>true</span><span style='color:#800080;'>;</span> var queryCompositionItemType <span style='color:#808030;'>=</span> operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#808030;'>.</span>ParameterType<span style='color:#808030;'>.</span>GetGenericArguments<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> queryCompositionType <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span>List<span style='color:#808030;'>&lt;</span><span style='color:#808030;'>&gt;</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>MakeGenericType<span style='color:#808030;'>(</span>queryCompositionItemType<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>override</span> IEnumerable<span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>string</span><span style='color:#808030;'>&gt;</span> SupportedMediaTypes <span style='color:#800080;'>{</span> get <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>new</span> List<span style='color:#808030;'>&lt;</span><span style='color:#800000;font-weight:bold;'>string</span><span style='color:#808030;'>&gt;</span> <span style='color:#800080;'>{</span> <span style='color:#800000;'>"</span><span style='color:#0000e6;'>text/xml</span><span style='color:#800000;'>"</span><span style='color:#808030;'>,</span> <span style='color:#800000;'>"</span><span style='color:#0000e6;'>application/xml</span><span style='color:#800000;'>"</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>override</span> <span style='color:#800000;font-weight:bold;'>void</span> WriteToStream<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span> instance<span style='color:#808030;'>,</span> System<span style='color:#808030;'>.</span>IO<span style='color:#808030;'>.</span>Stream stream<span style='color:#808030;'>,</span> HttpRequestMessage request<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#696969;'>//IQueryable support</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>usesQueryComposition<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#696969;'>//wrap it in a list</span> instance <span style='color:#808030;'>=</span> Activator<span style='color:#808030;'>.</span>CreateInstance<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>queryCompositionType<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> var serializer <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span> DataContractSerializer<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>queryCompositionType<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> serializer<span style='color:#808030;'>.</span>WriteObject<span style='color:#808030;'>(</span>stream<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800080;'>{</span> var serializer <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span> XmlSerializer<span style='color:#808030;'>(</span>instance<span style='color:#808030;'>.</span>GetType<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> serializer<span style='color:#808030;'>.</span>Serialize<span style='color:#808030;'>(</span>stream<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>override</span> <span style='color:#800000;font-weight:bold;'>object</span> ReadFromStream<span style='color:#808030;'>(</span>System<span style='color:#808030;'>.</span>IO<span style='color:#808030;'>.</span>Stream stream<span style='color:#808030;'>,</span> HttpRequestMessage request<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> var serializer <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span> XmlSerializer<span style='color:#808030;'>(</span>Parameter<span style='color:#808030;'>.</span>ParameterType<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>return</span> serializer<span style='color:#808030;'>.</span>Deserialize<span style='color:#808030;'>(</span>stream<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span>
</pre> The other big problem is that the IN argument of the MediaTypeProcessors is the Operation.ReturnValue.Name which is the name given to the return type of an operation. If we want the MediaTypeProcessors to serialize the output of our freaky processor, then we need to match the type and name of the out argument and in argument. The truth is that we don’t know the type of the out argument until we finish evaluating the navigation itself in execution time, so we are going to use something generic: typeof(object). And as for the name of the argument itself, let’s see a diagram of what we need: On the left side, is the current status of the pipeline, and in the right side is the desired status of the pipeline: <a href="http://machadogj.com/wp-content/uploads/2011/02/image4.png"><img style="display:inline;border:0;" title="image" src="http://machadogj.com/wp-content/uploads/2011/02/image_thumb4.png" border="0" alt="image" width="431" height="264" /></a> So we are going to “cheat” the MediaTypeProcessors into thinking that they will be processing the result of the Dispatching of the operation, but they will be processing the result of the navigation instead. We are going to cheat by receiving a list of processors in the constructor, and accessing the InArguments, and manipulating them:
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>public</span> NavigateProcessor<span style='color:#808030;'>(</span>HttpOperationDescription operation<span style='color:#808030;'>,</span> IList<span style='color:#808030;'>&lt;</span>Processor<span style='color:#808030;'>&gt;</span> processors<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>operation <span style='color:#808030;'>=</span> operation<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>mediaTypeProcessors <span style='color:#808030;'>=</span> processors<span style='color:#808030;'>.</span>Where<span style='color:#808030;'>(</span>p <span style='color:#808030;'>=</span><span style='color:#808030;'>&gt;</span> p <span style='color:#800000;font-weight:bold;'>is</span> MediaTypeProcessor<span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>ToList<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#696969;'>//cheat the in argument name of the media type processors.</span> <span style='color:#800000;font-weight:bold;'>foreach</span> <span style='color:#808030;'>(</span>var p <span style='color:#800000;font-weight:bold;'>in</span> processors<span style='color:#808030;'>.</span>OfType<span style='color:#808030;'>&lt;</span>MediaTypeProcessor<span style='color:#808030;'>&gt;</span><span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> var argument <span style='color:#808030;'>=</span> p<span style='color:#808030;'>.</span>InArguments<span style='color:#808030;'>.</span>Where<span style='color:#808030;'>(</span>a <span style='color:#808030;'>=</span><span style='color:#808030;'>&gt;</span> a<span style='color:#808030;'>.</span>Name <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#808030;'>.</span>Name<span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>First<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> argument<span style='color:#808030;'>.</span>Name <span style='color:#808030;'>=</span> NAVIGATE_RETURN_VALUE<span style='color:#800080;'>;</span> argument<span style='color:#808030;'>.</span>ArgumentType <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span>
</pre>
On the execution of the processor we are going to use the UriTemplate of the operation to search for the wildcard segments, and navigate those segments. For the navigation, since we might be accessing to a database or even a WCF DataService, we are going to abstract the navigation into a PropertyNavigator:
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>interface</span> IPropertyNavigator <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>object</span> Navigate<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span> instance<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>string</span> propertyName<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span>
</pre>
And obviously we are testing this with a reflection navigator:
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>class</span> ReflectionPropertyNavigator <span style='color:#808030;'>:</span> IPropertyNavigator <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>object</span> Navigate<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span> instance<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>string</span> propertyName<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>instance <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#808030;'>)</span> <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#800080;'>;</span> var prop <span style='color:#808030;'>=</span> instance<span style='color:#808030;'>.</span>GetType<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>GetProperties<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>Where<span style='color:#808030;'>(</span>p <span style='color:#808030;'>=</span><span style='color:#808030;'>&gt;</span> p<span style='color:#808030;'>.</span>Name<span style='color:#808030;'>.</span>ToLower<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> propertyName<span style='color:#808030;'>.</span>ToLower<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>FirstOrDefault<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>prop <span style='color:#808030;'>!</span><span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> var newReturnValue <span style='color:#808030;'>=</span> prop<span style='color:#808030;'>.</span>GetValue<span style='color:#808030;'>(</span>instance<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>return</span> newReturnValue<span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800000;font-weight:bold;'>throw</span> <span style='color:#800000;font-weight:bold;'>new</span> InvalidOperationException<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>string</span><span style='color:#808030;'>.</span>Format<span style='color:#808030;'>(</span><span style='color:#800000;'>"</span><span style='color:#0000e6;'>The property name {0} was not found in the type {1}</span><span style='color:#800000;'>"</span><span style='color:#808030;'>,</span> propertyName<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>.</span>GetType<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>Name<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span>
</pre>
<h1>The final monster</h1>
Before I show you the entire code, notice that this processor does not support collections, so I did a simple check over the IEnumerable interface on the OnExecute. So back to business:
<pre style='color:#000000;background:#ffffff;'><span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>class</span> NavigateProcessor <span style='color:#808030;'>:</span> Processor <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>const</span> <span style='color:#800000;font-weight:bold;'>string</span> NAVIGATE_RETURN_VALUE <span style='color:#808030;'>=</span> <span style='color:#800000;'>"</span><span style='color:#0000e6;'>_cheatReturnValue</span><span style='color:#800000;'>"</span><span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>private</span> HttpOperationDescription operation<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>private</span> IPropertyNavigator navigator<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>public</span> NavigateProcessor<span style='color:#808030;'>(</span>HttpOperationDescription operation<span style='color:#808030;'>,</span> IList<span style='color:#808030;'>&lt;</span>Processor<span style='color:#808030;'>&gt;</span> mediaTypeProcessors<span style='color:#808030;'>)</span><span style='color:#808030;'>:</span><span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>(</span>operation<span style='color:#808030;'>,</span> mediaTypeProcessors<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>new</span> ReflectionPropertyNavigator<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>public</span> NavigateProcessor<span style='color:#808030;'>(</span>HttpOperationDescription operation<span style='color:#808030;'>,</span> IList<span style='color:#808030;'>&lt;</span>Processor<span style='color:#808030;'>&gt;</span> processors<span style='color:#808030;'>,</span> IPropertyNavigator navigator<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>operation <span style='color:#808030;'>=</span> operation<span style='color:#800080;'>;</span> <span style='color:#696969;'>//cheat the in argument name of the media type processors.</span> <span style='color:#800000;font-weight:bold;'>foreach</span> <span style='color:#808030;'>(</span>var p <span style='color:#800000;font-weight:bold;'>in</span> processors<span style='color:#808030;'>.</span>OfType<span style='color:#808030;'>&lt;</span>MediaTypeProcessor<span style='color:#808030;'>&gt;</span><span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> var argument <span style='color:#808030;'>=</span> p<span style='color:#808030;'>.</span>InArguments<span style='color:#808030;'>.</span>Where<span style='color:#808030;'>(</span>a <span style='color:#808030;'>=</span><span style='color:#808030;'>&gt;</span> a<span style='color:#808030;'>.</span>Name <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#808030;'>.</span>Name<span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>First<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> argument<span style='color:#808030;'>.</span>Name <span style='color:#808030;'>=</span> NAVIGATE_RETURN_VALUE<span style='color:#800080;'>;</span> argument<span style='color:#808030;'>.</span>ArgumentType <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>this</span><span style='color:#808030;'>.</span>navigator <span style='color:#808030;'>=</span> navigator<span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>protected</span> <span style='color:#800000;font-weight:bold;'>override</span> ProcessorResult OnExecute<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span><span style='color:#808030;'>[</span><span style='color:#808030;'>]</span> input<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span>IEnumerable<span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>IsAssignableFrom<span style='color:#808030;'>(</span>operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#808030;'>.</span>ParameterType<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>new</span> ProcessorResult<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> Output <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span><span style='color:#808030;'>[</span><span style='color:#808030;'>]</span> <span style='color:#800080;'>{</span> input<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>object</span> returnValue <span style='color:#808030;'>=</span> input<span style='color:#808030;'>[</span><span style='color:#008c00;'>0</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> HttpRequestMessage request <span style='color:#808030;'>=</span> <span style='color:#808030;'>(</span>HttpRequestMessage<span style='color:#808030;'>)</span>input<span style='color:#808030;'>[</span><span style='color:#008c00;'>1</span><span style='color:#808030;'>]</span><span style='color:#800080;'>;</span> var uriTemplate <span style='color:#808030;'>=</span> operation<span style='color:#808030;'>.</span>GetUriTemplate<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> var baseAddress <span style='color:#808030;'>=</span> OperationContext<span style='color:#808030;'>.</span>Current<span style='color:#808030;'>.</span>Host<span style='color:#808030;'>.</span>BaseAddresses<span style='color:#808030;'>.</span>First<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> var navigations <span style='color:#808030;'>=</span> uriTemplate<span style='color:#808030;'>.</span>Match<span style='color:#808030;'>(</span>baseAddress<span style='color:#808030;'>,</span> request<span style='color:#808030;'>.</span>RequestUri<span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>WildcardPathSegments<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>object</span> newReturnValue <span style='color:#808030;'>=</span> returnValue<span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>foreach</span> <span style='color:#808030;'>(</span>var segment <span style='color:#800000;font-weight:bold;'>in</span> navigations<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> newReturnValue <span style='color:#808030;'>=</span> navigator<span style='color:#808030;'>.</span>Navigate<span style='color:#808030;'>(</span>newReturnValue<span style='color:#808030;'>,</span> segment<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>new</span> ProcessorResult<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> Output <span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>new</span><span style='color:#808030;'>[</span><span style='color:#808030;'>]</span> <span style='color:#800080;'>{</span> newReturnValue <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>protected</span> <span style='color:#800000;font-weight:bold;'>override</span> IEnumerable<span style='color:#808030;'>&lt;</span>ProcessorArgument<span style='color:#808030;'>&gt;</span> OnGetInArguments<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> yield <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>new</span> ProcessorArgument<span style='color:#808030;'>(</span>operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#808030;'>.</span>Name<span style='color:#808030;'>,</span> operation<span style='color:#808030;'>.</span>ReturnValue<span style='color:#808030;'>.</span>ParameterType<span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> yield <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>new</span> ProcessorArgument<span style='color:#808030;'>(</span>HttpPipelineFormatter<span style='color:#808030;'>.</span>ArgumentHttpRequestMessage<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span>HttpRequestMessage<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>protected</span> <span style='color:#800000;font-weight:bold;'>override</span> IEnumerable<span style='color:#808030;'>&lt;</span>ProcessorArgument<span style='color:#808030;'>&gt;</span> OnGetOutArguments<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> yield <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>new</span> ProcessorArgument<span style='color:#808030;'>(</span>NAVIGATE_RETURN_VALUE<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>typeof</span><span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#696969;'>//operation.ReturnValue.ParameterType);</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>class</span> ReflectionPropertyNavigator <span style='color:#808030;'>:</span> IPropertyNavigator <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>public</span> <span style='color:#800000;font-weight:bold;'>object</span> Navigate<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>object</span> instance<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>string</span> propertyName<span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>instance <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#808030;'>)</span> <span style='color:#800000;font-weight:bold;'>return</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#800080;'>;</span> var prop <span style='color:#808030;'>=</span> instance<span style='color:#808030;'>.</span>GetType<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>GetProperties<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>Where<span style='color:#808030;'>(</span>p <span style='color:#808030;'>=</span><span style='color:#808030;'>&gt;</span> p<span style='color:#808030;'>.</span>Name<span style='color:#808030;'>.</span>ToLower<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span> <span style='color:#808030;'>=</span><span style='color:#808030;'>=</span> propertyName<span style='color:#808030;'>.</span>ToLower<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>FirstOrDefault<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>if</span> <span style='color:#808030;'>(</span>prop <span style='color:#808030;'>!</span><span style='color:#808030;'>=</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#808030;'>)</span> <span style='color:#800080;'>{</span> var newReturnValue <span style='color:#808030;'>=</span> prop<span style='color:#808030;'>.</span>GetValue<span style='color:#808030;'>(</span>instance<span style='color:#808030;'>,</span> <span style='color:#800000;font-weight:bold;'>null</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800000;font-weight:bold;'>return</span> newReturnValue<span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800000;font-weight:bold;'>else</span> <span style='color:#800000;font-weight:bold;'>throw</span> <span style='color:#800000;font-weight:bold;'>new</span> InvalidOperationException<span style='color:#808030;'>(</span><span style='color:#800000;font-weight:bold;'>string</span><span style='color:#808030;'>.</span>Format<span style='color:#808030;'>(</span><span style='color:#800000;'>"</span><span style='color:#0000e6;'>The property name {0} was not found in the type {1}</span><span style='color:#800000;'>"</span><span style='color:#808030;'>,</span> propertyName<span style='color:#808030;'>,</span> instance<span style='color:#808030;'>.</span>GetType<span style='color:#808030;'>(</span><span style='color:#808030;'>)</span><span style='color:#808030;'>.</span>Name<span style='color:#808030;'>)</span><span style='color:#808030;'>)</span><span style='color:#800080;'>;</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span> <span style='color:#800080;'>}</span>
</pre>
So if you browse a url like this in the Contacts sample we showed before: <a href="http://localhost:5555/contacts/2/Name/Length">http://localhost:5555/contacts/2/Name/Length</a> we are going to get this response:
<pre style='color:#000000;background:#ffffff;'><span style='color:#004a43;'>&lt;?</span><span style='color:#004a43;'>xml</span> <span style='color:#004a43;'>version</span><span style='color:#808030;'>=</span><span style='color:#008c00;'>"1.0"</span> <span style='color:#004a43;'>?&gt;</span> <span style='color:#a65700;'>&lt;</span><span style='color:#5f5035;'>int</span><span style='color:#a65700;'>&gt;</span>11<span style='color:#a65700;'>&lt;/</span><span style='color:#5f5035;'>int</span><span style='color:#a65700;'>&gt;</span>
</pre>
It’s the length on the string property Name of the contact with id 5. So how cool is that????
NOTICE: This code is provided as is, and is not intended to demonstrate good practices, it's merely a demonstration of how flexible and fun working with WCF HTTP can be :)