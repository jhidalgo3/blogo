I decided to make this post to show to those that are not familiar with Parallel Extensions, how easy it is to go parallel with it. Parallel extensions were introduced in .NET 4.0 and it provides two new methods in the class System.Threading.Tasks.Parallel: For and ForEach. These methods allow you to perform tasks in parallel based on a collection of data. Here is a very simple example that clearly illustrates this:
<pre style="color:#000000;background:#ffffff;"><span style="color:#696969;"> //collection of data to iterate on</span> <span style="color:#800000;font-weight:bold;">int</span><span style="color:#808030;">[</span><span style="color:#808030;">]</span> numbers <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> <span style="color:#800000;font-weight:bold;">int</span><span style="color:#808030;">[</span><span style="color:#808030;">]</span><span style="color:#800080;">{</span><span style="color:#008c00;">1</span><span style="color:#808030;">,</span> <span style="color:#008c00;">2</span><span style="color:#808030;">,</span> <span style="color:#008c00;">3</span><span style="color:#808030;">,</span> <span style="color:#008c00;">4</span><span style="color:#808030;">,</span> <span style="color:#008c00;">5</span><span style="color:#800080;">}</span><span style="color:#800080;">;</span> var watch <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> Stopwatch<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//Run the tasks sequentially</span> watch<span style="color:#808030;">.</span>Start<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800000;font-weight:bold;">foreach</span><span style="color:#808030;">(</span> <span style="color:#800000;font-weight:bold;">int</span> i <span style="color:#800000;font-weight:bold;">in</span> numbers<span style="color:#808030;">)</span> <span style="color:#800080;">{</span> WaitForSeconds<span style="color:#808030;">(</span>i<span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800080;">}</span> watch<span style="color:#808030;">.</span>Stop<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Running sequentially:</span><span style="color:#800000;">"</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Elapsed: </span><span style="color:#800000;">"</span> <span style="color:#808030;">+</span> watch<span style="color:#808030;">.</span>ElapsedMilliseconds<span style="color:#808030;">.</span>ToString<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//close to 15000</span> watch<span style="color:#808030;">.</span>Reset<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//Now run them in parallel</span> watch<span style="color:#808030;">.</span>Start<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Parallel<span style="color:#808030;">.</span>ForEach<span style="color:#808030;">(</span>numbers<span style="color:#808030;">,</span> i <span style="color:#808030;">=</span><span style="color:#808030;">&gt;</span> WaitForSeconds<span style="color:#808030;">(</span>i<span style="color:#808030;">)</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> watch<span style="color:#808030;">.</span>Stop<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Running in parallel:</span><span style="color:#800000;">"</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Elapsed: </span><span style="color:#800000;">"</span> <span style="color:#808030;">+</span> watch<span style="color:#808030;">.</span>ElapsedMilliseconds<span style="color:#808030;">.</span>ToString<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//close to 5000 (depending on the # of cores)</span></pre>
Notice how easy it is to go from a foreach loop, to a a ForEach method call using a lambda expression. The real secret behind all this is to identify and make sure that the calls that are made to each element in the collection are independent from one another (which is why they can be done in Parallel). If you don't ensure this, you might get random bugs, and different behaviors for the same input (usually something not desireable at all). In adition to For and ForEach methods, parallel extensions also add some extension methods to make IEnumerable into ParallelQuery, and from ParallelQuery to IEnumerable. So if you haven't done so, go ahead and import the System.Threading.Tasks namespace to your project and start playing with it!