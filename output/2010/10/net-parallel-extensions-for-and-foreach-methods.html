<!DOCTYPE html>
<html lang="es">
  <head>
    <title>.NET Parallel Extensions - For and ForEach methods</title>
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/site.css" rel="stylesheet">
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container"><a data-toggle="collapse" data-target=".nav-collapse" class="btn btn-navbar"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><a href="/#" class="brand">machadogj</a>
          <ul class="nav">
            <li class=""><a href="/#">Home</a></li>
            <li class=""><a href="/about.html">About</a></li>
          </ul>
          <ul class="nav pull-right">
            <li>
              <form action="/search.html" method="get" class="navbar-search pull-left">
                <input name="q" type="text" placeholder="Search" class="search-query">
              </form>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <article class="span8">
          <header>
            <h1>.NET Parallel Extensions - For and ForEach methods</h1>
            <div>
              <address class="author">by<span> machadogj</span><br>on 
                <time datetime="2010-11-01T11:34" pubdate>01.11.2010 11:34</time>
              </address>
            </div>
          </header>
          <div class="content">I decided to make this post to show to those that are not familiar with Parallel Extensions, how easy it is to go parallel with it. Parallel extensions were introduced in .NET 4.0 and it provides two new methods in the class System.Threading.Tasks.Parallel: For and ForEach. These methods allow you to perform tasks in parallel based on a collection of data. Here is a very simple example that clearly illustrates this:
<pre style="color:#000000;background:#ffffff;"><span style="color:#696969;"> //collection of data to iterate on</span> <span style="color:#800000;font-weight:bold;">int</span><span style="color:#808030;">[</span><span style="color:#808030;">]</span> numbers <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> <span style="color:#800000;font-weight:bold;">int</span><span style="color:#808030;">[</span><span style="color:#808030;">]</span><span style="color:#800080;">{</span><span style="color:#008c00;">1</span><span style="color:#808030;">,</span> <span style="color:#008c00;">2</span><span style="color:#808030;">,</span> <span style="color:#008c00;">3</span><span style="color:#808030;">,</span> <span style="color:#008c00;">4</span><span style="color:#808030;">,</span> <span style="color:#008c00;">5</span><span style="color:#800080;">}</span><span style="color:#800080;">;</span> var watch <span style="color:#808030;">=</span> <span style="color:#800000;font-weight:bold;">new</span> Stopwatch<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//Run the tasks sequentially</span> watch<span style="color:#808030;">.</span>Start<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800000;font-weight:bold;">foreach</span><span style="color:#808030;">(</span> <span style="color:#800000;font-weight:bold;">int</span> i <span style="color:#800000;font-weight:bold;">in</span> numbers<span style="color:#808030;">)</span> <span style="color:#800080;">{</span> WaitForSeconds<span style="color:#808030;">(</span>i<span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#800080;">}</span> watch<span style="color:#808030;">.</span>Stop<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Running sequentially:</span><span style="color:#800000;">"</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Elapsed: </span><span style="color:#800000;">"</span> <span style="color:#808030;">+</span> watch<span style="color:#808030;">.</span>ElapsedMilliseconds<span style="color:#808030;">.</span>ToString<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//close to 15000</span> watch<span style="color:#808030;">.</span>Reset<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//Now run them in parallel</span> watch<span style="color:#808030;">.</span>Start<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Parallel<span style="color:#808030;">.</span>ForEach<span style="color:#808030;">(</span>numbers<span style="color:#808030;">,</span> i <span style="color:#808030;">=</span><span style="color:#808030;">&gt;</span> WaitForSeconds<span style="color:#808030;">(</span>i<span style="color:#808030;">)</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> watch<span style="color:#808030;">.</span>Stop<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Running in parallel:</span><span style="color:#800000;">"</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> Console<span style="color:#808030;">.</span>WriteLine<span style="color:#808030;">(</span><span style="color:#800000;">"</span><span style="color:#0000e6;">Elapsed: </span><span style="color:#800000;">"</span> <span style="color:#808030;">+</span> watch<span style="color:#808030;">.</span>ElapsedMilliseconds<span style="color:#808030;">.</span>ToString<span style="color:#808030;">(</span><span style="color:#808030;">)</span><span style="color:#808030;">)</span><span style="color:#800080;">;</span> <span style="color:#696969;">//close to 5000 (depending on the # of cores)</span></pre>
Notice how easy it is to go from a foreach loop, to a a ForEach method call using a lambda expression. The real secret behind all this is to identify and make sure that the calls that are made to each element in the collection are independent from one another (which is why they can be done in Parallel). If you don't ensure this, you might get random bugs, and different behaviors for the same input (usually something not desireable at all). In adition to For and ForEach methods, parallel extensions also add some extension methods to make IEnumerable into ParallelQuery, and from ParallelQuery to IEnumerable. So if you haven't done so, go ahead and import the System.Threading.Tasks namespace to your project and start playing with it!</div>
        </article>
        <div class="span4">
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <li class="nav-header">Latest Posts</li>
              <li><a href="/2012/4/stylus-a-better-css.html">Stylus, a better CSS</a></li>
              <li><a href="/2012/4/getting-started-with-express-for-node-js.html">Getting started with Express for node.js</a></li>
              <li><a href="/2012/4/getting-started-with-node-js.html">Getting started with node.js</a></li>
              <li><a href="/2012/0/unit-testing-and-test-driven-development-lessons-learned.html">Unit Testing and Test Driven Development (Lessons Learned)</a></li>
              <li><a href="/2011/9/unit-testing-wit-knockout-js-with-tdd.html">Unit Testing with Knockout.js</a></li>
              <li><a href="/archive.html">See more >></a></li>
            </ul>
          </div>
        </div>
      </div>
      <hr>copyright 2012 <a href="http://machadogj.com">machadogj.com</a> by <a href="http://twitter.com/machadogj">@machadogj</a><br><br>
    </div>
    <script src="/js/bootstrap.js"></script>
  </body>
</html>